<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sindibad Chat Service Mock</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                Chat Service Mock
            </h1>
            <p class="text-gray-600">
                Simulate chat messages to test the webhook and tagging system
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Chat Interface -->
            <div class="bg-white rounded-lg shadow-lg">
                <div class="border-b border-gray-200 px-6 py-4">
                    <h2 class="text-xl font-semibold text-gray-800">Chat Conversation</h2>
                    <div class="mt-2 flex items-center space-x-4">
                        <div>
                            <label for="conversation-id" class="block text-sm font-medium text-gray-700">Conversation ID:</label>
                            <input type="text" id="conversation-id" 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   placeholder="Enter conversation ID or leave blank for auto-generation">
                        </div>
                        <div>
                            <button onclick="generateConversationId()" 
                                    class="mt-6 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm">
                                Generate New
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 h-96 overflow-y-auto" id="chat-messages">
                    <div class="text-center text-gray-500 py-8">
                        <p>Start a conversation by sending a message below</p>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 px-6 py-4">
                    <div class="flex space-x-2">
                        <input type="text" id="message-input" 
                               placeholder="Type your message here..."
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessage()" 
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Send
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        Press Enter to send message
                    </div>
                </div>
            </div>

            <!-- Quick Actions & Status -->
            <div class="space-y-6">
                <!-- Quick Message Templates -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Message Templates</h3>
                    <div class="space-y-2">
                        <button onclick="sendQuickMessage('I need to cancel my flight booking')" 
                                class="w-full text-left px-3 py-2 text-sm bg-red-50 hover:bg-red-100 rounded border border-red-200">
                            üõ´ Flight Cancellation
                        </button>
                        <button onclick="sendQuickMessage('I want to modify my hotel reservation')" 
                                class="w-full text-left px-3 py-2 text-sm bg-blue-50 hover:bg-blue-100 rounded border border-blue-200">
                            üè® Hotel Modification
                        </button>
                        <button onclick="sendQuickMessage('Can you check my visa application status?')" 
                                class="w-full text-left px-3 py-2 text-sm bg-green-50 hover:bg-green-100 rounded border border-green-200">
                            üìÑ Visa Status Check
                        </button>
                        <button onclick="sendQuickMessage('I need to top up my eSIM data plan')" 
                                class="w-full text-left px-3 py-2 text-sm bg-purple-50 hover:bg-purple-100 rounded border border-purple-200">
                            üì± eSIM Top Up
                        </button>
                        <button onclick="sendQuickMessage('How do I add money to my wallet?')" 
                                class="w-full text-left px-3 py-2 text-sm bg-yellow-50 hover:bg-yellow-100 rounded border border-yellow-200">
                            üí∞ Wallet Top Up
                        </button>
                        <button onclick="sendQuickMessage('Hello, I need help with something')" 
                                class="w-full text-left px-3 py-2 text-sm bg-gray-50 hover:bg-gray-100 rounded border border-gray-200">
                            üí¨ General Inquiry
                        </button>
                    </div>
                </div>

                <!-- Connection Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Connection Status</h3>
                    <div class="flex items-center space-x-2" id="connection-status">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-gray-600">Connected to webhook</span>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm text-gray-600">Webhook URL:</p>
                        <code class="text-xs bg-gray-100 px-2 py-1 rounded">/api/webhooks/messages</code>
                    </div>
                </div>

                <!-- Recent Responses -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Last Response</h3>
                    <div id="last-response" class="text-sm text-gray-500">
                        No responses yet
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Actions</h3>
                    <div class="space-y-2">
                        <button onclick="clearChat()" 
                                class="w-full bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm">
                            Clear Chat
                        </button>
                        <a href="/dashboard" 
                           class="block w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm text-center">
                            View Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConversationId = '';
        let messageHistory = [];

        function generateConversationId() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8);
            currentConversationId = `chat_${timestamp}_${random}`;
            document.getElementById('conversation-id').value = currentConversationId;
        }

        function getConversationId() {
            const input = document.getElementById('conversation-id').value.trim();
            if (input) {
                currentConversationId = input;
                return input;
            }
            if (!currentConversationId) {
                generateConversationId();
            }
            return currentConversationId;
        }

        function addMessageToChat(message, sender, timestamp = null) {
            const chatMessages = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            if (sender === 'user') {
                messageElement.innerHTML = `
                    <div class="flex justify-end mb-4">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 bg-blue-500 text-white rounded-lg">
                            <p class="text-sm">${message}</p>
                            <p class="text-xs text-blue-100 mt-1">${time}</p>
                        </div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="flex justify-start mb-4">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 bg-gray-200 text-gray-800 rounded-lg">
                            <p class="text-sm">${message}</p>
                            <p class="text-xs text-gray-500 mt-1">${time}</p>
                        </div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Clear the "Start conversation" message if it exists
            const emptyMessage = chatMessages.querySelector('.text-center.text-gray-500');
            if (emptyMessage) {
                emptyMessage.remove();
            }
        }

        async function sendMessage(messageText = null) {
            const messageInput = document.getElementById('message-input');
            const message = messageText || messageInput.value.trim();
            
            if (!message) return;

            const conversationId = getConversationId();
            document.getElementById('conversation-id').value = conversationId;

            // Add user message to chat
            addMessageToChat(message, 'user');
            messageHistory.push({
                text: message,
                sender: 'user',
                timestamp: new Date().toISOString()
            });

            // Clear input if it was from the input field
            if (!messageText) {
                messageInput.value = '';
            }

            // Send to webhook
            try {
                updateConnectionStatus('sending', 'Sending message...');
                
                const response = await fetch('/api/webhooks/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: conversationId,
                        messages: [{
                            text: message,
                            sender: 'user',
                            timestamp: new Date().toISOString()
                        }]
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    updateConnectionStatus('connected', 'Message sent successfully');
                    updateLastResponse(result);
                    
                    // If there's a bot response in the result, show it
                    if (result.bot_response) {
                        setTimeout(() => {
                            addMessageToChat(result.bot_response.text, 'bot', result.bot_response.timestamp);
                        }, 500);
                    }
                } else {
                    const error = await response.text();
                    updateConnectionStatus('error', `Error: ${response.status}`);
                    console.error('Webhook error:', error);
                }
            } catch (error) {
                updateConnectionStatus('error', 'Connection failed');
                console.error('Network error:', error);
            }
        }

        function sendQuickMessage(message) {
            sendMessage(message);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connection-status');
            let color = 'green';
            if (status === 'sending') color = 'yellow';
            if (status === 'error') color = 'red';
            
            statusElement.innerHTML = `
                <div class="w-3 h-3 bg-${color}-500 rounded-full"></div>
                <span class="text-sm text-gray-600">${message}</span>
            `;
        }

        function updateLastResponse(response) {
            const lastResponseElement = document.getElementById('last-response');
            lastResponseElement.innerHTML = `
                <div class="text-xs">
                    <strong>Status:</strong> ${response.status || 'success'}<br>
                    <strong>Ticket ID:</strong> ${response.ticket_id || 'N/A'}<br>
                    <strong>Tags:</strong> ${response.tags ? JSON.stringify(response.tags) : 'N/A'}
                </div>
            `;
        }

        function clearChat() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p>Start a conversation by sending a message below</p>
                </div>
            `;
            messageHistory = [];
            document.getElementById('conversation-id').value = '';
            currentConversationId = '';
        }

        // Initialize with a conversation ID
        document.addEventListener('DOMContentLoaded', function() {
            generateConversationId();
        });
    </script>
</body>
</html>
